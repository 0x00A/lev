#!/usr/bin/env node

var fs = require('fs')
var path = require('path')
var net = require('net')
var readline = require('readline')

var argv = require('optimist').argv
var deepmerge = require('deepmerge')
var reconnect = require('reconnect')

var Sublevel = require('level-sublevel')
var multilevel = require('multilevel')
var deleteRange = require("level-delete-range")
var level = require('level')

var utils = require('./lib/utils')

var db

try {
  var settingsFile = utils.find('.lev.json');
  var defaults = JSON.parse(fs.readFileSync(settingsFile)) || {}
  argv = deepmerge(argv, defaults)
}
catch(ex) {

  if (ex.name === 'SyntaxError') {
    console.log('error parsing settings file [%s]', ex.message)
  }
}

if (argv.encoding) {
  argv.keyEncoding = argv.encoding
  argv.valueEncoding = argv.encoding
}

if (argv.port) {
  reconnect(function (connection) {
    db = multilevel.client()
    db.pipe(connection).pipe(db)
  }).listen(argv.port)
}
else {
  db = level(utils.location(), argv)
}

db = Sublevel(db)

var allCommands = ['get', 'delr']

var args = utils.filter(Object.keys(argv), allCommands.concat(Object.keys(db)))
db.on('EncodingError', function(a, b, c) {
  console.log(a, b, c)
})

db.on('error', function(a, b, c) {
  console.log(a, b, c)
})

args.length > 0 
  ? require('./lib/cli')(argv, db) 
  : require('./lib/repl')(argv, db)
