#!/usr/bin/env node
var fs = require('fs')
var args = require('optimist')
var pkg = require('./package.json')
var UI = require('./lib/ui')

var client
var output
var log

var model = {
  query: {
    start: '',
    end: '',
    reverse: false,
    limit: 1000
  },
  key: null,
  settings: {}
}

var argv = args
  .usage('\nUSAGE: lev [path] [options]')

  .alias('t', 'tree')
  .describe('tree', 'List sublevels as a tree')

  .describe('c', 'Creates a database')

  .alias('d', 'del')
  .describe('del', 'Remove an entity')

  .alias('g', 'get')
  .describe('get', 'Get an record based on the key')

  .describe('put --value', 'Insert a new value')  

  .alias('k', 'keys')
  .describe('keys', 'Return only keys')

  .alias('l', 'limit')
  .describe('limit', 'The number of entities to return')

  .alias('s', 'start')
  .describe('start', 'The starting key for a read')

  .alias('e', 'end')
  .describe('end', 'The end key')

  .describe('cd', 'Change into or create a sublevel')

  .alias('h', 'help')
  .describe('help', 'Print this help text')
  .argv

function printHelp() {
  console.log(args.help())
  process.exit(0)
}

if (argv.h || argv.help) {
  printHelp()
}

if (process.argv.length > 2) {
  log = console.log
}
else {
  var ui = UI(model)
  log = ui.log
}

log('\n' + pkg.name, 'version', pkg.version)
log('level version', pkg.dependencies.level + '\n')

if (process.argv.length > 2) {

  if (argv._.length == 0) {
    console.log('No path specified')
    process.exit(1)
  }

  if (argv.i) {
    require('./lib/repl')(argv, model)
  }
  else {
    require('./lib/cli')(argv, model)
  }
}
